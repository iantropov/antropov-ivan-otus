# Project Work: MyCode

## Описание

**MyCode** - каталог задач по программированию

### Функционал:

- Для работы с каталогом нужно зарегистрировать пользователя и аутентифицироваться в системе
- В системе существуют 2 типа пользователей администраторы и обычные пользователи
- Администраторы могут создавать/удалять/редактировать/читать задачи
- Администраторы могут создавать/читать категории задач
- Администраторы могут смотреть/удалять пользователей
- Администраторы и обычные пользователи могут лайкать задачи
- Администраторы и обычные пользователи могут просматривать списки залайканных задачи
- Администраторы и обычные пользователи могут искать задачи по фильтрам:
  - Текст в заголовке/описании задачи
  - Присутствие в списке избранных у пользователя
  - Наличие выбранных категорий у задачи

### Особенности реализации:

- В качестве языка системы был выбран TypeScript
- Система реализована с использованием фреймворков
  - NestJS для бэкенда приложения
  - NextJS для фронтенда приложения
- Для хранения данных используется MongoDB
  - В среде разработки - в docker контейнере
  - В развёрнутой версии - в MongoDB Atlas
- Для обмена данными между клиентом/сервером используется GraphQL
  - На сервере используется ApolloServer
  - На клиенте используется ApolloClient
- Реализована аутентификация с использованием Passport и стратегий:
  - Сессий через cookie
  - JWT токенов в заголовках
- Для развертывания приложения был выбран PaaS Heroku
- Для тестирования используется Jest:
  - На бэке реализован unit-тест - categories.service.spec.ts
  - На бэке реализован e2e-тест - categories.e2e.spec.ts

## Deployment

Приложение развёрнуто в Heroku: https://otus-my-code.herokuapp.com/

В развёрнутом приложении используется MongoDB Atlas

## Playbook

### Локальная разработка

```
docker-compose -d up
npm run start:dev
```

### Развёртывание

```
heroku login
heroku git:remote -a otus-my-code
heroku config:push --file=.production.env
git push heroku master
```

## Interesting Links

### MongoDB

https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design


## Реализация

```
Сущности:
- User
  - id: ObjectId
  - name: string
  - email: sting
  - isAdmin: boolean
  - favourites: ObjectId[]
- Problem
  - id: ObjectId
  - categories: [{id: ObjectId, name: string}]
  - description: string
  - summary?: string
  - solution: string
- Category
  - id: ObjectId
  - name: string

Админ заводится при старте системы

Use Cases:
- Регистрация пользователя
- Логин пользователя
- Под админом:
  - просмотр категорий
  - добавление категорий
  - просмотр пользователей
  - удаление пользователей
  - поиск задач
  - добавление задач
  - редактирование задач
  - удаление задач
  - добавление в избранные
  - удаление из избранного
  - просмотр избранных задач
- Под пользователем
  - поиск задач
  - добавление в избранное
  - удаление из избранного
  - просмотр избранных задач

Roadmap:
- бэкенд
  + сделать скелет проекта
  + завести пользователей
  + завести задачи
  + подключить GraphQL
  + сделать резолверы
  + сделать аутентификацию/авторизацию через jwt и заголовки
  + сделать логаут
  + добавить любимые задачи
  + добавить категории
  + реализовать поиск задач
  + закрыть роуты гардами
  + добавить валидаций
  + обработка невалидного ID (например, 1)
  + обработка ошибок GraphQL в http-exception.filter
  + валидация на уникальный email
  + сделать solution опциональным
  + добавить логирование БД и посмотреть на запросы связей
  + убрать JWT_SECRET в окружение
  -? добавить индексы (уникальные и на поля)
  -? добавить хранение сессий в редис
  -? добавить протухание сессий (ttl)
- фронтенд
  + завести фронт на nextjs
  + подключить apollo client
  + сделать страницу логина
  + сделать логаут
  + подключить bootstrap
  + сделать layout приложения
  + завезти заголовок дологина
  + завезти заголовок залогина
  + сделать футер
  + сделать страницу регистрации
  + сделать страницу задач
    - https://getbootstrap.com/docs/5.2/examples/list-groups/#
    - https://getbootstrap.com/docs/5.2/components/collapse/
  + сделать страницу любимых задач
  + сделать заголовок админа
  + сделать страницу пользовалей
  + сделать удаление пользователя
  + сделать добавление задачи
  + сделать страницу редактирования задачи
  + сделать удаление задачи
  + переверстать компонент задачи
  + сделать лайк
  + доделать создание задач с категориями
  + доделать вывод задач с категориями
  + добавить текстовый поиск по задачам
  + добавить поиск по категориям задач
  + завести компонент Main
  + переделать потоки данных (мутации только в компонентах-контейнерах)
  + добавить пагинацию
  + добавить заведение категорий
  + добавить отображение категорий
  -? редактирование права на Админа
  -? добавить валидаций
  + централизовать обработку ошибок apollo (error-link)
  + улучшить сообщения об ошибках
  -? добавить подтверждение удалений
  -? порефакторить мультиселект
  -? порефакторить формы - в отдельный компонент
  + добавить всплывашки об успехе операций
  -? отказаться от _id в пользу id на фронте
+ Деплой (в качестве последней домашки):
  + подключение mongodb через Mongo Atlas
  + Регистрация на Heroku
  + деплой приложения
- Тестирование
  + Тесты на бэке
    + in-memory database
    + unit test
    + e2e test
  -? Тесты на фронт
    -? e2e тесты на Playwright
```

## Followups

К сожалению, в виду ограничений по времени не успел реализовать следующие моменты:
- Покрыть полноценно бэкенд юнит тестами
- Покрыть полноценно бэкенд интеграционными тестами
- Покрыть фронтент acceptance тестами
- Реализовать механизм миграций для MongoDB
- Реализовать механизм seed данных (для удобства разработки и тестирования)
- Перевести хранение сессий из MemoryStore (негодного для прода) в Redis
- Подключить инструменты для отлова ошибок (Sentry, NewRelic)
- Подключить инструменты для работы с логами (ELK)
- Подключить инструменты для сбора метрик (Prometheus)
- Реализовать CI pipeline на GitHub с прогоном тестов и линтеров
- Добавить в CI инструменты для статического анализа кода (Snyke, SonarQube)
- Реализовать CD по кнопке в облако (IaC/terraform/ansible)
- Перенести MongoDB и Redis в облако

=================================

## Useful snippets

```
show databases;
use my-code;
db.users.updateOne({_id: ObjectId("63635a5ac773205aea27306c")}, {$set:{isAdmin: true}})
```